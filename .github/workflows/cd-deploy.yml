name: CD - Deploy

on:
  push:
    # tags:
    #   - 'v*.*.*'

env:
  ENVIRONMENT: production
  CLOUD_PROVIDER: azure

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      infra-changed: ${{ steps.detect.outputs.infra_changed }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      - name: Detect infrastructure changes
        id: detect
        run: |
          TAG_COMMIT=$(git rev-list -n 1 ${{ steps.version.outputs.version }})
          
          # Get list of tags
          ALL_TAGS=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$')
          
          # Extract specifically the 2nd line (previous tag)
          PREV_TAG=$(echo "$ALL_TAGS" | sed -n '2p')
          
          if [ -z "$PREV_TAG" ]; then
            echo "First deployment detected (no previous tag). Forcing infra deploy."
            echo "infra_changed=true" >> $GITHUB_OUTPUT
          else
            echo "Comparing against previous tag: $PREV_TAG"
            if git diff --name-only $PREV_TAG $TAG_COMMIT | grep -qE '^infra/(terraform|ansible)/'; then
              echo "Infrastructure changes detected"
              echo "infra_changed=true" >> $GITHUB_OUTPUT
            else
              echo "No infrastructure changes"
              echo "infra_changed=false" >> $GITHUB_OUTPUT
            fi
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: check-changes
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache Python virtualenv
        uses: actions/cache@v4
        id: cache-venv
        with:
          path: |
            .venv
            backend/.venv
            infra/.venv
          key: venv-${{ runner.os }}-py3.11-${{ hashFiles('**/requirements*.txt', 'backend/pyproject.toml', 'infra/requirements.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.11-
        
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/app/package-lock.json'
      
      - name: Cache Terraform providers
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infra/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infra/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-
      
      - name: Cache Ansible Galaxy collections
        uses: actions/cache@v4
        with:
          path: ~/.ansible/collections
          key: ansible-${{ runner.os }}-${{ hashFiles('infra/ansible/dependencies.yml') }}
          restore-keys: |
            ansible-${{ runner.os }}-
      
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false
      
      - name: Configure Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Set Azure subscription
        run: az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install dependencies # CAN WE ADD CACHING HERE?
        run: make install-ci-cd
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          CLOUD_PROVIDER: ${{ env.CLOUD_PROVIDER }}
      
      - name: Deploy with infrastructure
        if: needs.check-changes.outputs.infra-changed == 'true'
        run: make deploy-prod-with-infra
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          CLOUD_PROVIDER: ${{ env.CLOUD_PROVIDER }}
          BACKEND_VERSION: ${{ needs.check-changes.outputs.version }}
      
      - name: Deploy without infrastructure
        if: needs.check-changes.outputs.infra-changed == 'false'
        run: make deploy-start
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          CLOUD_PROVIDER: ${{ env.CLOUD_PROVIDER }}
          BACKEND_VERSION: ${{ needs.check-changes.outputs.version }}
      
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.check-changes.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Infrastructure Updated**: ${{ needs.check-changes.outputs.infra-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment complete!" >> $GITHUB_STEP_SUMMARY