# name: CD - Deploy

# on:
#   push:
#     branches:
#       - main
#       - production
#     paths:
#       - 'backend/**'
#       - 'frontend/**'
#       - 'infra/**'
#       - 'deployment/**'
#       - '.github/workflows/cd-deploy.yml'

# env:
#   ENVIRONMENT: production
#   CLOUD_PROVIDER: azure

# jobs:
#   detect-changes:
#     runs-on: ubuntu-latest
#     outputs:
#       infra-changed: ${{ steps.changes.outputs.infra }}
#       backend-changed: ${{ steps.changes.outputs.backend }}
#       frontend-changed: ${{ steps.changes.outputs.frontend }}
#     steps:
#       - uses: actions/checkout@v4
#         with:
#           fetch-depth: 2
      
#       - name: Detect changes
#         id: changes
#         run: |
#           if git diff --name-only HEAD~1 HEAD | grep -qE '^infra/'; then
#             echo "infra=true" >> $GITHUB_OUTPUT
#           else
#             echo "infra=false" >> $GITHUB_OUTPUT
#           fi
          
#           if git diff --name-only HEAD~1 HEAD | grep -qE '^backend/'; then
#             echo "backend=true" >> $GITHUB_OUTPUT
#           else
#             echo "backend=false" >> $GITHUB_OUTPUT
#           fi
          
#           if git diff --name-only HEAD~1 HEAD | grep -qE '^frontend/'; then
#             echo "frontend=true" >> $GITHUB_OUTPUT
#           else
#             echo "frontend=false" >> $GITHUB_OUTPUT
#           fi

#   deploy:
#     runs-on: ubuntu-latest
#     needs: detect-changes
#     if: needs.detect-changes.outputs.infra-changed == 'true' || needs.detect-changes.outputs.backend-changed == 'true' || needs.detect-changes.outputs.frontend-changed == 'true'
    
#     steps:
#       - uses: actions/checkout@v4
      
#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.11'
      
#       - name: Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'
      
#       - name: Configure Azure credentials
#         uses: azure/login@v2
#         with:
#           creds: ${{ secrets.AZURE_CREDENTIALS }}
#           enable-AzPSSession: true
      
#       - name: Set Azure subscription
#         run: |
#           az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
#           az account show
      
#       - name: Install system dependencies
#         run: |
#           sudo apt-get update
#           sudo apt-get install -y make jq
      
#       - name: Install Terraform
#         uses: hashicorp/setup-terraform@v3
#         with:
#           terraform_version: '1.6.0'
      
#       - name: Install Ansible
#         run: |
#           sudo apt-get update
#           sudo apt-get install -y ansible
      
#       - name: Install infra dependencies
#         working-directory: ./infra
#         run: |
#           python3.11 -m venv .venv
#           source .venv/bin/activate
#           pip3 install -r ./requirements.txt
#           pip install boto3 botocore
#           ansible-galaxy install -r ./ansible/dependencies.yml
#         env:
#           ENVIRONMENT: ${{ env.ENVIRONMENT }}
#           CLOUD_PROVIDER: ${{ env.CLOUD_PROVIDER }}
      
#       - name: Install backend dependencies
#         working-directory: ./backend
#         run: make install
#         env:
#           ENVIRONMENT: ${{ env.ENVIRONMENT }}
      
#       - name: Install frontend dependencies
#         working-directory: ./frontend
#         run: make install
#         env:
#           ENVIRONMENT: ${{ env.ENVIRONMENT }}
      
#       - name: Configure Docker Buildx
#         uses: docker/setup-buildx-action@v3
      
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}
      
#       - name: Deploy with infrastructure
#         if: needs.detect-changes.outputs.infra-changed == 'true'
#         run: make deploy-start
#         env:
#           ENVIRONMENT: ${{ env.ENVIRONMENT }}
#           CLOUD_PROVIDER: ${{ env.CLOUD_PROVIDER }}
      
#       - name: Initialize Terraform (for sync without infra changes)
#         if: needs.detect-changes.outputs.infra-changed == 'false'
#         working-directory: ./infra
#         run: |
#           source .venv/bin/activate
#           cd terraform/${{ env.CLOUD_PROVIDER }}/environment/${{ env.ENVIRONMENT }} && terraform init
#         env:
#           ENVIRONMENT: ${{ env.ENVIRONMENT }}
#           CLOUD_PROVIDER: ${{ env.CLOUD_PROVIDER }}
      
#       - name: Sync environment files (without infra changes)
#         if: needs.detect-changes.outputs.infra-changed == 'false'
#         working-directory: ./infra
#         run: |
#           source .venv/bin/activate
#           make sync_all
#         env:
#           ENVIRONMENT: ${{ env.ENVIRONMENT }}
#           CLOUD_PROVIDER: ${{ env.CLOUD_PROVIDER }}
      
#       - name: Deploy without infrastructure
#         if: needs.detect-changes.outputs.infra-changed == 'false'
#         run: make deploy-start-without-infra
#         env:
#           ENVIRONMENT: ${{ env.ENVIRONMENT }}
#           CLOUD_PROVIDER: ${{ env.CLOUD_PROVIDER }}
      
#       - name: Verify deployment files exist
#         run: |
#           if [ ! -f "./backend/env_config/synced/.env.${{ env.ENVIRONMENT }}" ]; then
#             echo "Error: Backend env file not found"
#             exit 1
#           fi
#           if [ ! -f "./infra/ansible/inventory/${{ env.ENVIRONMENT }}.ini" ]; then
#             echo "Error: Ansible inventory file not found"
#             exit 1
#           fi
#           echo "âœ… All required deployment files exist"

