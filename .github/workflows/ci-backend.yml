name: CI - Backend

on:
  push:
    branches:
      - '**'
    paths:
      - 'backend/**'
      - '.github/workflows/ci-backend.yml'
  pull_request:
    branches:
      - '**'
    paths:
      - 'backend/**'

env:
  PYTHON_VERSION: '3.11'
  WORKING_DIR: ./backend

jobs:
  # ------------------------------------------------------------------
  # STAGE 1: FAST CHECKS
  # ------------------------------------------------------------------
  lint-and-security:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "backend/pyproject.toml"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: make install

      - name: Run linting checks
        run: make format

      - name: Run security scan
        run: make static-security-analysis

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: backend/bandit-report.json

  unit-tests:
    runs-on: ubuntu-latest
    needs: lint-and-security
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "backend/pyproject.toml"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: make install-full

      # ADDED: Create .env.test because conftest.py needs it
      - name: Create Test Environment Config
        run: |
          mkdir -p env_config/synced
          cat > env_config/synced/.env.test << EOF
          ENVIRONMENT="test"
          CLOUD_PROVIDER="azure"
          USING_FIREBASE_EMULATOR="true"
          FB_AUTH_EMULATOR_HOST="localhost:19099"
          FB_PROJECT_ID="url-shortener-abadb"
          REDIS_URL="redis://localhost:6379"
          MYSQL_USER="root"
          MYSQL_PASSWORD="rootpassword"
          MYSQL_HOST="database"
          MYSQL_PORT="3306"
          MYSQL_DATABASE="url_shortener"
          MYSQL_SYNC_DRIVER="mysql+pymysql"
          MYSQL_ASYNC_DRIVER="mysql+aiomysql"
          AWS_MAIN_REGION="us-east-1"
          S3_MAIN_BUCKET_NAME="test-bucket"
          AZURE_STORAGE_ACCOUNT_NAME="storage_acc"
          AZURE_STORAGE_ACCOUNT_KEY="storage_acc_key"
          AZURE_STORAGE_CONTAINER_NAME="images"
          EOF

      - name: Run unit tests
        env:
          ENVIRONMENT: test
        run: make unit-test

      - name: Upload coverage results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/coverage.xml

  smoke-tests:
    runs-on: ubuntu-latest
    needs: lint-and-security
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "backend/pyproject.toml"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: make install

      # ADDED: Create .env.test because conftest.py needs it
      - name: Create Test Environment Config
        run: |
          mkdir -p env_config/synced
          cat > env_config/synced/.env.test << EOF
          ENVIRONMENT="test"
          CLOUD_PROVIDER="azure"
          USING_FIREBASE_EMULATOR="true"
          FB_AUTH_EMULATOR_HOST="localhost:19099"
          FB_PROJECT_ID="url-shortener-abadb"
          REDIS_URL="redis://localhost:6379"
          MYSQL_USER="root"
          MYSQL_PASSWORD="rootpassword"
          MYSQL_HOST="database"
          MYSQL_PORT="3306"
          MYSQL_DATABASE="url_shortener"
          MYSQL_SYNC_DRIVER="mysql+pymysql"
          MYSQL_ASYNC_DRIVER="mysql+aiomysql"
          AWS_MAIN_REGION="us-east-1"
          S3_MAIN_BUCKET_NAME="test-bucket"
          AZURE_STORAGE_ACCOUNT_NAME="storage_acc"
          AZURE_STORAGE_ACCOUNT_KEY="storage_acc_key"
          AZURE_STORAGE_CONTAINER_NAME="images"
          EOF

      - name: Run smoke tests
        env:
          ENVIRONMENT: test
        run: make smoke-test

  # ------------------------------------------------------------------
  # STAGE 2: HEAVY TESTS
  # ------------------------------------------------------------------
  integration-and-regression:
    runs-on: ubuntu-latest
    needs: [unit-tests, smoke-tests]
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "backend/pyproject.toml"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: make install

      - name: Create Test Environment Config
        run: |
          mkdir -p env_config/synced
          cat > env_config/synced/.env.test << EOF
          ENVIRONMENT="test"
          CLOUD_PROVIDER="azure"
          USING_FIREBASE_EMULATOR="true"
          FB_AUTH_EMULATOR_HOST="localhost:19099"
          FB_PROJECT_ID="url-shortener-abadb"
          REDIS_URL="redis://localhost:6379"
          MYSQL_USER="root"
          MYSQL_PASSWORD="rootpassword"
          MYSQL_HOST="database"
          MYSQL_PORT="3306"
          MYSQL_DATABASE="url_shortener"
          MYSQL_SYNC_DRIVER="mysql+pymysql"
          MYSQL_ASYNC_DRIVER="mysql+aiomysql"
          AWS_MAIN_REGION="us-east-1"
          S3_MAIN_BUCKET_NAME="test-bucket"
          AZURE_STORAGE_ACCOUNT_NAME="storage_acc"
          AZURE_STORAGE_ACCOUNT_KEY="storage_acc_key"
          AZURE_STORAGE_CONTAINER_NAME="images"
          EOF

      - name: Start Docker Environment
        env:
          ENVIRONMENT: test
        run: |
          make test-start
          echo "Waiting for services to stabilize..."
          sleep 15

      - name: Run Integration Tests
        run: make integration-test

      - name: Run Regression Tests
        run: make regression-test

      - name: Stop Docker Environment
        if: always()
        env:
          ENVIRONMENT: test
        run: make test-stop

  # load-tests:
  #   runs-on: ubuntu-latest
  #   needs: [unit-tests, smoke-tests]
  #   if: github.event_name == 'pull_request' && github.base_ref == 'main'
  #   defaults:
  #     run:
  #       working-directory: ${{ env.WORKING_DIR }}

  #   steps:
  #     - uses: actions/checkout@v4

  #     # --- [Setup Steps: Install K6, UV, Python, Dependencies, .env file] ---
  #     # (Copy these from your previous working snippet to keep this readable)
  #     - name: Install k6
  #       run: |
  #         sudo gpg -k
  #         sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
  #         echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
  #         sudo apt-get update
  #         sudo apt-get install k6

  #     - name: Install uv
  #       uses: astral-sh/setup-uv@v3
  #       with:
  #         enable-cache: true
  #         cache-dependency-glob: "backend/pyproject.toml"

  #     - name: Set up Python ${{ env.PYTHON_VERSION }}
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}

  #     - name: Install dependencies
  #       run: make install

  #     - name: Create Test Environment Config
  #       run: |
  #         mkdir -p env_config/synced
  #         cat > env_config/synced/.env.test << EOF
  #         ENVIRONMENT="test"
  #         CLOUD_PROVIDER="azure"
  #         USING_FIREBASE_EMULATOR="true"
  #         FB_AUTH_EMULATOR_HOST="localhost:19099"
  #         FB_PROJECT_ID="url-shortener-abadb"
  #         REDIS_URL="redis://localhost:6379"
  #         MYSQL_USER="root"
  #         MYSQL_PASSWORD="rootpassword"
  #         MYSQL_HOST="database"
  #         MYSQL_PORT="3306"
  #         MYSQL_DATABASE="url_shortener"
  #         MYSQL_SYNC_DRIVER="mysql+pymysql"
  #         MYSQL_ASYNC_DRIVER="mysql+aiomysql"
  #         AWS_MAIN_REGION="us-east-1"
  #         S3_MAIN_BUCKET_NAME="test-bucket"
  #         AZURE_STORAGE_ACCOUNT_NAME="storage_acc"
  #         AZURE_STORAGE_ACCOUNT_KEY="storage_acc_key"
  #         AZURE_STORAGE_CONTAINER_NAME="images"
  #         EOF

  #     - name: Start Full Stack (DB + Backend)
  #       env:
  #         ENVIRONMENT: test
  #       run: make test-start

  #     - name: Verify Backend Health
  #       run: |
  #         timeout 30s bash -c 'until curl -s --fail http://localhost:8000/api/health/ping; do sleep 2; done'

  #     - name: Run Load Tests
  #       run: make load-tests

  #     - name: Stop Docker Environment
  #       if: always()
  #       env:
  #         ENVIRONMENT: test
  #       run: make test-stop

  #     - name: Upload K6 Results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: k6-load-test-results
  #         path: backend/test/load/k6-results.json
