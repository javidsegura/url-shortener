name: CI - Backend

on:
  push:
    branches:
      - '**'
    paths:
      - 'backend/**'
      - '.github/workflows/ci-backend.yml'
  pull_request:
    branches:
      - '**'
    paths:
      - 'backend/**'

jobs:
  lint-and-security: # DEBUG: gotta add linter too (currently just formatter)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: ${{ runner.os }}-venv-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-venv-
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: make install-full
      
      # - name: Run linting checks
      #   working-directory: ./backend
      #   run: make lint-check

      - name: Run linting checks
        working-directory: ./backend
        run: make format
      
      - name: Run security scan
        working-directory: ./backend
        run: make static-security-analysis
      
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: backend/bandit-report.json

#   unit-tests:
#     runs-on: ubuntu-latest
#     needs: lint-and-security
    
#     steps:
#       - uses: actions/checkout@v4
      
#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.11'
      
#       - name: Cache Python dependencies
#         uses: actions/cache@v4
#         with:
#           path: .venv
#           key: ${{ runner.os }}-venv-${{ hashFiles('**/pyproject.toml') }}
#           restore-keys: |
#             ${{ runner.os }}-venv-
      
#       - name: Install dependencies
#         working-directory: ./backend
#         run: make install
      
#       - name: Run unit tests
#         working-directory: ./backend
#         run: |
#           source ../.venv/bin/activate
#           pytest test/unit/ -v \
#             --cov=src \
#             --cov-report=xml \
#             --cov-report=term \
#             --junitxml=test-results.xml
      
#       - name: Upload coverage to Codecov
#         uses: codecov/codecov-action@v4
#         with:
#           file: ./backend/coverage.xml
#           flags: unit
#           name: backend-unit-coverage
      
#       - name: Upload test results
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: unit-test-results
#           path: backend/test-results.xml

#   integration-tests:
#     runs-on: ubuntu-latest
#     needs: lint-and-security
    
#     steps:
#       - uses: actions/checkout@v4
      
#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.11'
      
#       - name: Cache Python dependencies
#         uses: actions/cache@v4
#         with:
#           path: .venv
#           key: ${{ runner.os }}-venv-${{ hashFiles('**/pyproject.toml') }}
      
#       - name: Install dependencies
#         working-directory: ./backend
#         run: make install
      
#       - name: Create test environment file
#         working-directory: ./backend
#         run: |
#           mkdir -p env_config/synced
#           cat > env_config/synced/.env.test << EOF
#           ENVIRONMENT=test
#           DATABASE_URL=postgresql://postgres:testpass@localhost:5432/testdb
#           REDIS_URL=redis://localhost:6379
#           EOF
      
#       - name: Start test environment
#         working-directory: ./backend
#         env:
#           ENVIRONMENT: test
#         run: make test-docker-compose-start
      
#       - name: Wait for services
#         run: |
#           echo "Waiting for services to be ready..."
#           sleep 20
#           docker ps
      
#       - name: Run integration tests
#         working-directory: ./backend
#         run: make pytest-run
      
#       - name: Stop test environment
#         if: always()
#         working-directory: ./backend
#         env:
#           ENVIRONMENT: test
#         run: make test-docker-compose-stop
      
#       - name: Upload integration test results
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: integration-test-results
#           path: backend/test-results.xml

#   smoke-and-regression-tests:
#     runs-on: ubuntu-latest
#     needs: [unit-tests, integration-tests]
    
#     steps:
#       - uses: actions/checkout@v4
      
#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.11'
      
#       - name: Cache Python dependencies
#         uses: actions/cache@v4
#         with:
#           path: .venv
#           key: ${{ runner.os }}-venv-${{ hashFiles('**/pyproject.toml') }}
      
#       - name: Install dependencies
#         working-directory: ./backend
#         run: make install
      
#       - name: Create test environment file
#         working-directory: ./backend
#         run: |
#           mkdir -p env_config/synced
#           cat > env_config/synced/.env.test << EOF
#           ENVIRONMENT=test
#           EOF
      
#       - name: Start test environment
#         working-directory: ./backend
#         env:
#           ENVIRONMENT: test
#         run: make test-docker-compose-start
      
#       - name: Wait for services
#         run: sleep 20
      
#       - name: Run smoke tests
#         working-directory: ./backend
#         run: |
#           source ../.venv/bin/activate
#           pytest test/smoke/ -v --maxfail=1
      
#       - name: Run regression tests
#         working-directory: ./backend
#         if: always()
#         run: |
#           source ../.venv/bin/activate
#           pytest test/regression/ -v --tb=short
      
#       - name: Stop test environment
#         if: always()
#         working-directory: ./backend
#         env:
#           ENVIRONMENT: test
#         run: make test-docker-compose-stop